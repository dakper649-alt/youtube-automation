"""
Output Manager - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
–°–æ–∑–¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –Ω–∞ Desktop —Å SEO –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
"""

import os
import shutil
from pathlib import Path
from datetime import datetime
from typing import Dict


class OutputManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫"""

    def __init__(self, base_output_dir: str = None):
        """
        Args:
            base_output_dir: –ë–∞–∑–æ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                           –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: ~/Desktop/YouTube_Videos/
        """
        if base_output_dir is None:
            desktop = Path.home() / "Desktop"
            self.base_output_dir = desktop / "YouTube_Videos"
        else:
            self.base_output_dir = Path(base_output_dir)

        # –°–æ–∑–¥–∞—ë–º –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        self.base_output_dir.mkdir(parents=True, exist_ok=True)

    def create_video_project(self, title: str, metadata: Dict) -> Path:
        """
        –°–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –¥–ª—è –≤–∏–¥–µ–æ

        Args:
            title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∏–¥–µ–æ
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–∏—à–∞, —Å—Ç–∏–ª—å, –≥–æ–ª–æ—Å, –∏ —Ç.–¥.)

        Returns:
            –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
        """

        # –°–æ–∑–¥–∞—ë–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è –ø–∞–ø–∫–∏
        safe_title = self._sanitize_filename(title)
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

        project_name = f"{timestamp}_{safe_title[:50]}"
        project_dir = self.base_output_dir / project_name

        # –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        project_dir.mkdir(parents=True, exist_ok=True)
        (project_dir / "images").mkdir(exist_ok=True)
        (project_dir / "temp").mkdir(exist_ok=True)

        print(f"üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: {project_dir}")

        return project_dir

    def save_final_video(
        self,
        video_path: str,
        project_dir: Path,
        metadata: Dict,
        cleanup_temp: bool = True
    ) -> Path:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∏ —Å–æ–∑–¥–∞—ë—Ç SEO —Ñ–∞–π–ª

        Args:
            video_path: –ü—É—Ç—å –∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –≤–∏–¥–µ–æ
            project_dir: –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
            metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è SEO
            cleanup_temp: –£–¥–∞–ª—è—Ç—å –ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

        Returns:
            –ü—É—Ç—å –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –≤–∏–¥–µ–æ
        """

        # –ö–æ–ø–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
        final_video_path = project_dir / "video.mp4"
        shutil.copy2(video_path, final_video_path)

        print(f"‚úÖ –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {final_video_path}")

        # –°–æ–∑–¥–∞—ë–º SEO —Ñ–∞–π–ª
        self._create_seo_file(project_dir, metadata)

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        if cleanup_temp:
            temp_dir = project_dir / "temp"
            if temp_dir.exists():
                shutil.rmtree(temp_dir)
                print(f"üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã")

        # –°–æ–∑–¥–∞—ë–º README
        self._create_readme(project_dir, metadata)

        return final_video_path

    def _create_seo_file(self, project_dir: Path, metadata: Dict):
        """–°–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª —Å SEO –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"""

        seo_path = project_dir / "SEO_METADATA.txt"

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        from services.seo_generator import SEOGenerator
        seo_gen = SEOGenerator()

        seo_data = seo_gen.generate_seo_metadata(
            title=metadata.get('title', ''),
            script=metadata.get('script', ''),
            niche=metadata.get('niche', ''),
            metadata=metadata
        )

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª
        with open(seo_path, 'w', encoding='utf-8') as f:
            f.write(seo_data)

        print(f"üìù SEO –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {seo_path}")

    def _create_readme(self, project_dir: Path, metadata: Dict):
        """–°–æ–∑–¥–∞—ë—Ç README —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–µ–∫—Ç–µ"""

        readme_path = project_dir / "README.txt"

        content = f"""
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
YOUTUBE VIDEO PROJECT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìå –ù–ê–ó–í–ê–ù–ò–ï: {metadata.get('title', 'N/A')}
üéØ –ù–ò–®–ê: {metadata.get('niche', 'N/A')}
üìÖ –î–ê–¢–ê –°–û–ó–î–ê–ù–ò–Ø: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìÅ –°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

video.mp4           - –ì–æ—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ YouTube
SEO_METADATA.txt    - –ó–∞–≥–æ–ª–æ–≤–∫–∏, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–≥–∏ –¥–ª—è YouTube
script.txt          - –¢–µ–∫—Å—Ç —Å–∫—Ä–∏–ø—Ç–∞ (–µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω)
audio.mp3           - –ê—É–¥–∏–æ —Ñ–∞–π–ª (–µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω)
images/             - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ–æ

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üé® –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 1920x1080 (Full HD)
FPS: 30
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {metadata.get('duration', 'N/A')} —Å–µ–∫—É–Ω–¥
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {metadata.get('image_count', 'N/A')}
–°—Ç–∏–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {metadata.get('style', 'N/A')}
–ì–æ–ª–æ—Å: {metadata.get('voice', 'N/A')}
–°—É–±—Ç–∏—Ç—Ä—ã: {metadata.get('subtitle_style', 'N/A')}
–Ø–∑—ã–∫: {metadata.get('language', 'ru')}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìù –ö–ê–ö –ó–ê–ì–†–£–ó–ò–¢–¨ –ù–ê YOUTUBE:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

1. –û—Ç–∫—Ä–æ–π YouTube Studio (studio.youtube.com)
2. –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å" ‚Üí "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ"
3. –í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª: video.mp4
4. –°–∫–æ–ø–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ SEO_METADATA.txt:
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ 3 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
   - –û–ø–∏—Å–∞–Ω–∏–µ
   - –¢–µ–≥–∏
5. –ó–∞–≥—Ä—É–∑–∏ –º–∏–Ω–∏–∞—Ç—é—Ä—É (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –ø–∞–ø–∫–µ thumbnails/)
6. –û–ø—É–±–ª–∏–∫—É–π!

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üéâ –ì–û–¢–û–í–û! –£–°–ü–ï–•–û–í –ù–ê YOUTUBE! üöÄ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
"""

        with open(readme_path, 'w', encoding='utf-8') as f:
            f.write(content)

        print(f"üìñ README —Å–æ–∑–¥–∞–Ω: {readme_path}")

    def _sanitize_filename(self, filename: str) -> str:
        """–î–µ–ª–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º"""

        # –ó–∞–º–µ–Ω—è–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
        invalid_chars = '<>:"/\\|?*'
        for char in invalid_chars:
            filename = filename.replace(char, '_')

        # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
        filename = ' '.join(filename.split())

        # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è
        filename = filename.replace(' ', '_')

        return filename
